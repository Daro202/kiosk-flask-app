<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wykres Średniej Prędkości - Firmowy Kiosk</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Plotly.js - Self-hosted fallback -->
    <script>
    // Plotly basic minimal implementation fallback
    window.PlotlyConfig = {MathJaxConfig: 'local'};
    </script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" onerror="loadPlotlyFallback()"></script>
    <script>
    function loadPlotlyFallback() {
        // Jeśli CDN nie działa, załaduj z alternatywnego źródła
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.0/plotly.min.js';
        script.onerror = function() {
            console.error('Nie można załadować Plotly z żadnego CDN');
        };
        document.head.appendChild(script);
    }
    </script>
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Nagłówek -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Wykres Średniej Prędkości</h1>
            <p class="text-gray-600">Interaktywny wykres danych produkcyjnych z pliku Export.xlsx</p>
        </div>
        
        <!-- Filtry -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Dropdown Typ -->
                <div>
                    <label for="typ-select" class="block text-sm font-medium text-gray-700 mb-2">
                        Typ
                    </label>
                    <select id="typ-select" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        {% for t in typy %}
                        <option value="{{ t }}" {% if t == default_typ %}selected{% endif %}>
                            {{ t }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Dropdown Kod -->
                <div>
                    <label for="kod-select" class="block text-sm font-medium text-gray-700 mb-2">
                        Kod Maszyny
                    </label>
                    <select id="kod-select" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        {% for k in kody %}
                        <option value="{{ k }}" {% if k == default_kod %}selected{% endif %}>
                            {{ k }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Dropdown Brygada -->
                <div>
                    <label for="brygada-select" class="block text-sm font-medium text-gray-700 mb-2">
                        Brygada
                    </label>
                    <select id="brygada-select" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        {% for b in brygady %}
                        <option value="{{ b }}" {% if b == default_brygada %}selected{% endif %}>
                            {{ b }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Wykres -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div id="chart" style="width: 100%; height: 600px;">
                {{ plot_html|safe }}
            </div>
        </div>
        
        <!-- Przycisk powrotu -->
        <div class="mt-6 text-center">
            <a href="/" class="inline-block bg-orange-500 hover:bg-orange-600 text-white font-semibold px-6 py-3 rounded-lg transition duration-200">
                ← Powrót do Dashboardu
            </a>
        </div>
    </div>
    
    <script>
        // Pobierz elementy
        const typSelect = document.getElementById('typ-select');
        const kodSelect = document.getElementById('kod-select');
        const brygadaSelect = document.getElementById('brygada-select');
        const chartDiv = document.getElementById('chart');
        
        // Funkcja aktualizująca wykres
        async function updateChart() {
            const typ = typSelect.value;
            const kod = kodSelect.value;
            const brig = brygadaSelect.value;
            
            try {
                // Pobierz dane z API
                const response = await fetch(`/api/series?typ=${encodeURIComponent(typ)}&kod=${encodeURIComponent(kod)}&brig=${encodeURIComponent(brig)}`);
                const data = await response.json();
                
                // Sprawdź czy Plotly jest załadowany
                if (typeof Plotly !== 'undefined') {
                    // Znajdź div wykresu Plotly (wygenerowany przez Python)
                    const plotlyDiv = chartDiv.querySelector('.plotly-graph-div') || chartDiv;
                    
                    // Przygotuj dane dla Plotly
                    const trace = {
                        x: data.x,
                        y: data.y,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: `${typ} - ${kod} - ${brig}`,
                        line: {
                            color: '#FF6B35',
                            width: 3
                        },
                        marker: {
                            color: '#FF6B35',
                            size: 8
                        }
                    };
                    
                    // Layout wykresu
                    const layout = {
                        title: {
                            text: `Średnia prędkość – ${data.typ}, Kod ${data.kod}, Brygada ${data.brig}`,
                            font: {
                                size: 20,
                                family: 'Roboto, sans-serif'
                            }
                        },
                        xaxis: {
                            title: 'Dzień miesiąca',
                            showgrid: true,
                            gridcolor: '#e5e7eb',
                            dtick: 1
                        },
                        yaxis: {
                            title: 'Wartość [m2/wh]',
                            showgrid: true,
                            gridcolor: '#e5e7eb'
                        },
                        plot_bgcolor: '#f9fafb',
                        paper_bgcolor: 'white',
                        hovermode: 'closest'
                    };
                    
                    // Aktualizuj lub utwórz wykres
                    Plotly.react(plotlyDiv, [trace], layout, {responsive: true});
                } else {
                    console.error('Plotly nie jest załadowany');
                }
                
            } catch (error) {
                console.error('Błąd pobierania danych:', error);
            }
        }
        
        // Obsługa zmiany dropdownów
        typSelect.addEventListener('change', updateChart);
        kodSelect.addEventListener('change', updateChart);
        brygadaSelect.addEventListener('change', updateChart);
    </script>
</body>
</html>
