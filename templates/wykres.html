<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wykres ≈öredniej Prƒôdko≈õci - Firmowy Kiosk</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Nag≈Ç√≥wek -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Wykres ≈öredniej Prƒôdko≈õci</h1>
            <p class="text-gray-600">Interaktywny wykres danych produkcyjnych z pliku Export.xlsx</p>
        </div>
        
        <!-- Filtry -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="max-w-md">
                <!-- Dropdown Maszyna -->
                <div>
                    <label for="maszyna-select" class="block text-sm font-medium text-gray-700 mb-2">
                        Kod Maszyny
                    </label>
                    <select id="maszyna-select" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        {% for m in maszyny %}
                        <option value="{{ m.kod }}" {% if m.kod == default_kod %}selected{% endif %}>
                            {{ m.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Wykres -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div id="chart-container" style="width: 100%; height: 600px;">
                <div id="chart">
                    {{ plot_html|safe }}
                </div>
            </div>
        </div>
        
        <!-- Przycisk powrotu -->
        <div class="mt-6 text-center">
            <a href="/" class="inline-block bg-orange-500 hover:bg-orange-600 text-white font-semibold px-6 py-3 rounded-lg transition duration-200">
                ‚Üê Powr√≥t do Dashboardu
            </a>
        </div>
    </div>
    
    <script>
        // Poczekaj na za≈Çadowanie DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM za≈Çadowany');
            
            // Pobierz elementy
            const maszynaSelect = document.getElementById('maszyna-select');
            const chartDiv = document.getElementById('chart');
            
            if (!maszynaSelect || !chartDiv) {
                console.error('‚ùå Nie znaleziono element√≥w DOM');
                return;
            }
            
            console.log('‚úÖ Elementy DOM znalezione');
            
            // Obs≈Çuga zmiany dropdown
            maszynaSelect.addEventListener('change', updateChart);
            console.log('‚úÖ Event listener dodany');
            
            // Funkcja aktualizujƒÖca wykres
            async function updateChart() {
                const kod = maszynaSelect.value;
                console.log('üîÑ Aktualizacja wykresu dla maszyny:', kod);
                
                if (!kod) {
                    console.log('‚ùå Brak kodu maszyny');
                    return;
                }
                
                try {
                    // Pobierz dane z API
                    console.log('üì° Pobieranie danych z API...');
                    const response = await fetch(`/api/series?kod=${encodeURIComponent(kod)}`);
                    const data = await response.json();
                    console.log('‚úÖ Otrzymano dane:', data);
                    
                    // Sprawd≈∫ czy Plotly jest za≈Çadowany
                    if (typeof Plotly !== 'undefined') {
                        // Znajd≈∫ div wykresu Plotly (wygenerowany przez Python)
                        const plotlyDiv = chartDiv.querySelector('.plotly-graph-div');
                        
                        if (!plotlyDiv) {
                            console.error('‚ùå Nie znaleziono div Plotly');
                            return;
                        }
                        
                        console.log('‚úÖ Plotly div znaleziony');
                    
                    // Przygotuj dane dla Plotly
                    const traces = [];
                    
                    // Dodaj ka≈ºdƒÖ seriƒô z API
                    for (const serie of data.series) {
                        if (serie.type === 'bar') {
                            traces.push({
                                x: serie.x,
                                y: serie.y,
                                type: 'bar',
                                name: serie.name,
                                marker: {
                                    color: serie.color
                                },
                                text: serie.y,
                                textposition: 'outside',
                                texttemplate: '%{text:.0f}',
                                yaxis: serie.yaxis || 'y'
                            });
                        } else if (serie.type === 'line') {
                            traces.push({
                                x: serie.x,
                                y: serie.y,
                                type: 'scatter',
                                mode: 'lines+markers',
                                name: serie.name,
                                line: {
                                    color: serie.color,
                                    width: 2
                                },
                                marker: {
                                    color: serie.color,
                                    size: 6
                                },
                                yaxis: serie.yaxis || 'y'
                            });
                        }
                    }
                    
                    // Oblicz maksymalnƒÖ warto≈õƒá ze wszystkich danych dla synchronizacji osi
                    let maxValue = 0;
                    for (const trace of traces) {
                        const traceMax = Math.max(...trace.y);
                        if (traceMax > maxValue) {
                            maxValue = traceMax;
                        }
                    }
                    // Dodaj 10% marginesu na g√≥rze
                    maxValue = Math.ceil(maxValue * 1.1);
                    
                    // Layout wykresu
                    const layout = {
                        title: {
                            text: data.nazwa ? `${data.kod} ${data.nazwa}` : data.kod,
                            font: {
                                size: 20,
                                family: 'Roboto, sans-serif'
                            }
                        },
                        xaxis: {
                            title: '',
                            showgrid: true,
                            gridcolor: '#e5e7eb',
                            dtick: 1
                        },
                        yaxis: {
                            title: 'Produkcja dzienna',
                            showgrid: true,
                            gridcolor: '#e5e7eb',
                            side: 'left',
                            range: [0, maxValue]
                        },
                        yaxis2: {
                            title: 'Produkcja narastajƒÖca',
                            showgrid: false,
                            overlaying: 'y',
                            side: 'right',
                            range: [0, maxValue]
                        },
                        plot_bgcolor: 'white',
                        paper_bgcolor: 'white',
                        hovermode: 'x unified',
                        barmode: 'group',
                        showlegend: true,
                        legend: {
                            orientation: 'h',
                            yanchor: 'bottom',
                            y: -0.2,
                            xanchor: 'center',
                            x: 0.5
                        }
                    };
                    
                    // Aktualizuj lub utw√≥rz wykres
                    console.log('üìä Aktualizacja wykresu Plotly...');
                    Plotly.react(plotlyDiv, traces, layout, {responsive: true});
                    console.log('‚úÖ Wykres zaktualizowany!');
                } else {
                    console.error('‚ùå Plotly nie jest za≈Çadowany');
                }
                
                } catch (error) {
                    console.error('‚ùå B≈ÇƒÖd pobierania danych:', error);
                }
            }
        });
    </script>
</body>
</html>
