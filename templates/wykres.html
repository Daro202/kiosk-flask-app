<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wykres Średniej Prędkości - Firmowy Kiosk</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Nagłówek -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Wykres Średniej Prędkości</h1>
            <p class="text-gray-600">Interaktywny wykres danych produkcyjnych z pliku Export.xlsx</p>
        </div>
        
        <!-- Filtry -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="max-w-md">
                <!-- Dropdown Maszyna -->
                <div>
                    <label for="maszyna-select" class="block text-sm font-medium text-gray-700 mb-2">
                        Kod Maszyny
                    </label>
                    <select id="maszyna-select" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        {% for m in maszyny %}
                        <option value="{{ m.kod }}" {% if m.kod == default_kod %}selected{% endif %}>
                            {{ m.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Wykres -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div id="chart" style="width: 100%; height: 600px;">
                {{ plot_html|safe }}
            </div>
        </div>
        
        <!-- Przycisk powrotu -->
        <div class="mt-6 text-center">
            <a href="/" class="inline-block bg-orange-500 hover:bg-orange-600 text-white font-semibold px-6 py-3 rounded-lg transition duration-200">
                ← Powrót do Dashboardu
            </a>
        </div>
    </div>
    
    <script>
        // Pobierz elementy
        const maszynaSelect = document.getElementById('maszyna-select');
        const chartDiv = document.getElementById('chart');
        
        // Funkcja aktualizująca wykres
        async function updateChart() {
            const kod = maszynaSelect.value;
            
            if (!kod) {
                console.log('Brak kodu maszyny');
                return;
            }
            
            try {
                // Pobierz dane z API
                const response = await fetch(`/api/series?kod=${encodeURIComponent(kod)}`);
                const data = await response.json();
                
                // Sprawdź czy Plotly jest załadowany
                if (typeof Plotly !== 'undefined') {
                    // Znajdź div wykresu Plotly (wygenerowany przez Python)
                    const plotlyDiv = chartDiv.querySelector('.plotly-graph-div') || chartDiv;
                    
                    // Przygotuj dane dla Plotly
                    const traces = [];
                    
                    // Dodaj każdą serię z API
                    for (const serie of data.series) {
                        if (serie.type === 'bar') {
                            traces.push({
                                x: serie.x,
                                y: serie.y,
                                type: 'bar',
                                name: serie.name,
                                marker: {
                                    color: serie.color
                                },
                                text: serie.y,
                                textposition: 'outside',
                                texttemplate: '%{text:.0f}',
                                yaxis: serie.yaxis || 'y'
                            });
                        } else if (serie.type === 'line') {
                            traces.push({
                                x: serie.x,
                                y: serie.y,
                                type: 'scatter',
                                mode: 'lines+markers',
                                name: serie.name,
                                line: {
                                    color: serie.color,
                                    width: 2
                                },
                                marker: {
                                    color: serie.color,
                                    size: 6
                                },
                                yaxis: serie.yaxis || 'y'
                            });
                        }
                    }
                    
                    // Layout wykresu
                    const layout = {
                        title: {
                            text: data.nazwa ? `${data.kod} ${data.nazwa}` : data.kod,
                            font: {
                                size: 20,
                                family: 'Roboto, sans-serif'
                            }
                        },
                        xaxis: {
                            title: '',
                            showgrid: true,
                            gridcolor: '#e5e7eb',
                            dtick: 1
                        },
                        yaxis: {
                            title: '',
                            showgrid: true,
                            gridcolor: '#e5e7eb',
                            side: 'left'
                        },
                        yaxis2: {
                            title: '',
                            showgrid: false,
                            overlaying: 'y',
                            side: 'right'
                        },
                        plot_bgcolor: 'white',
                        paper_bgcolor: 'white',
                        hovermode: 'x unified',
                        barmode: 'group',
                        showlegend: true,
                        legend: {
                            orientation: 'h',
                            yanchor: 'bottom',
                            y: -0.2,
                            xanchor: 'center',
                            x: 0.5
                        }
                    };
                    
                    // Aktualizuj lub utwórz wykres
                    Plotly.react(plotlyDiv, traces, layout, {responsive: true});
                } else {
                    console.error('Plotly nie jest załadowany');
                }
                
            } catch (error) {
                console.error('Błąd pobierania danych:', error);
            }
        }
        
        // Obsługa zmiany dropdown
        maszynaSelect.addEventListener('change', updateChart);
    </script>
</body>
</html>
